<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ARãƒ•ãƒ©ãƒ¯ãƒ¼ãƒ©ã‚¤ãƒŠãƒ¼ - Hybrid Edition</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
    #top-ui-container { position: fixed; top: 20px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
    #bottom-ui-container { position: fixed; bottom: 30px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
    .ui-bar, .pad-grid { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(8px); pointer-events: auto; }
    .ui-bar { display: flex; gap: 6px; padding: 5px 8px; border-radius: 15px; }
    .pad-grid { display: grid; gap: 8px; padding: 15px; border-radius: 20px; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); }
    .btn { width: 55px; height: 55px; background: #ffffff; border: none; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 22px; color: #556677; cursor: pointer; }
    .btn-active { background: #ffffcc !important; border: 2px solid #ffcc00 !important; }
    .btn-icon { flex-direction: column; font-size: 10px; color: #333; }
    .btn-icon span { font-size: 18px; }
    .mode-switch { background: #333 !important; color: #fff !important; font-weight: bold; width: 80px !important; }
    .mode-gps { background: #007bff !important; }
    #debug-info { position: fixed; bottom: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); font-size: 10px; z-index: 10000; pointer-events: none; }
  </style>
</head>
<body>

<div id="debug-info">ãƒ¢ãƒ¼ãƒ‰: è‡ªç”±é…ç½® (Manual)</div>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
  renderer="precision: mediump; antialias: true; alpha: true; colorManagement: true; exposure: 1.2;"
>
  <a-assets>
    <audio id="snd-horn" src="horn.mp3" preload="auto"></audio>
    <audio id="snd-run" src="run.mp3" preload="auto" loop></audio>
  </a-assets>

  <a-light type="ambient" color="#FFF" intensity="1.5"></a-light>
  <a-light type="directional" position="-1 4 2" intensity="1.0"></a-light>
  <a-light type="hemisphere" color="#FFF" groundColor="#444" intensity="1.2"></a-light>

  <a-camera id="main-camera" rotation-reader></a-camera>

  <a-entity id="train"
            gltf-model="models/AR-Train_Nagai.glb"
            position="0 0 -15"
            rotation="0 180 0"
            scale="5.0 5.0 5.0">
    </a-entity>
</a-scene>

<div id="top-ui-container">
  <div class="ui-bar">
    <div class="btn mode-switch" id="btn-mode">GPS OFF</div>
    <div class="btn btn-icon" id="btn-horn"><span>ğŸ“¢</span><div>è­¦ç¬›</div></div>
    <div class="btn btn-icon" id="btn-zoom-in"><span>ğŸ”</span><div>+</div></div>
    <div class="btn btn-icon" id="btn-zoom-out"><span>ğŸ”</span><div>-</div></div>
    <div class="btn btn-icon" id="btn-capture"><span>ğŸ“·</span><div>æ’®</div></div>
  </div>
</div>

<div id="bottom-ui-container">
  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>
    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>
    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
const train = document.querySelector('#train');
const camera = document.querySelector('#main-camera');
const btnMode = document.getElementById('btn-mode');
const debug = document.getElementById('debug-info');

let isGpsMode = false;
// é•·äº•é§…ã®åº§æ¨™
const targetLat = 38.114742; 
const targetLon = 140.033621;

btnMode.onclick = () => {
  isGpsMode = !isGpsMode;
  if (isGpsMode) {
    btnMode.innerText = "GPS ON";
    btnMode.classList.add('mode-gps');
    debug.innerText = "ãƒ¢ãƒ¼ãƒ‰: é•·äº•é§…GPSå›ºå®š";
    camera.setAttribute('gps-camera', 'simulateLatitude: 0; simulateLongitude: 0;');
    train.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
    train.removeAttribute('position'); 
  } else {
    location.reload(); 
  }
};

let state = { moving: 0, turning: 0 };
let zoomState = 0;
let curScale = 5.0;

function loop() {
  requestAnimationFrame(loop);
  if (!train.object3D) return;
  const mesh = train.object3D;

  if (state.turning !== 0) {
    mesh.rotation.y += THREE.MathUtils.degToRad(1.5) * state.turning;
  }
  if (state.moving !== 0) {
    const forward = new THREE.Vector3(0, 0, 1);
    forward.applyQuaternion(mesh.quaternion);
    mesh.position.addScaledVector(forward, state.moving * 0.15);
  }
  if (zoomState !== 0) {
    curScale += zoomState * 0.05;
    curScale = Math.max(0.1, curScale);
    mesh.scale.set(curScale, curScale, curScale);
  }
}
loop();

function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  const start = (e) => { if(e.cancelable) e.preventDefault(); state.moving = moveVal; state.turning = turnVal; };
  const end = (e) => { if(e.cancelable) e.preventDefault(); state.moving = 0; state.turning = 0; };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', end);
}
setAction('btn-fwd', 1, 0); setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1); setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1); setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1); setAction('btn-curve-right-back', -1, -1);
document.getElementById('btn-stop').onclick = () => { state.moving = 0; state.turning = 0; };

const startZoomIn = (e) => { if(e.cancelable) e.preventDefault(); zoomState = 1; };
const startZoomOut = (e) => { if(e.cancelable) e.preventDefault(); zoomState = -1; };
const stopZoom = (e) => { if(e.cancelable) e.preventDefault(); zoomState = 0; };
document.getElementById('btn-zoom-in').addEventListener('touchstart', startZoomIn, {passive:false});
document.getElementById('btn-zoom-out').addEventListener('touchstart', startZoomOut, {passive:false});
window.addEventListener('touchend', stopZoom);

const hornAudio = document.getElementById('snd-horn');
document.getElementById('btn-horn').onclick = () => { hornAudio.play(); };

document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  cvs.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ar_snapshot.png'; a.click(); });
};
</script>
</body>
</html>