<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ARãƒ•ãƒ©ãƒ¯ãƒ¼ãƒ©ã‚¤ãƒŠãƒ¼</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>

  <style>
    /* ========== UIãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰ ========== */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; background: #000; font-family: sans-serif;
      user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
    }
    a-scene { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; display: block; }
    .a-canvas, #arjs-video { width: 100% !important; height: 100% !important; object-fit: cover !important; }

    /* UIé…ç½® */
    #top-ui-container {
      position: fixed; top: 20px; left: 0; width: 100%; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none;
    }
    #bottom-ui-container {
      position: fixed; bottom: 30px; left: 0; width: 100%; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none;
    }

    /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .ui-bar, .pad-grid {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); pointer-events: auto;
    }
    .ui-bar { display: flex; gap: 6px; padding: 5px 8px; border-radius: 15px; }
    .pad-grid {
      display: grid; gap: 8px; padding: 15px; border-radius: 20px;
      grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px);
    }

    .btn {
      width: 55px; height: 55px; background: #ffffff; border: none; border-radius: 12px;
      display: flex; justify-content: center; align-items: center;
      font-size: 22px; color: #556677; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: scale(0.96); background: #f5f5f5; }
    .btn-active { background: #ffffcc !important; border: 2px solid #ffcc00 !important; }

    .btn-icon { flex-direction: column; gap: 0px; font-size: 10px; color: #333; }
    .btn-icon span { font-size: 20px; line-height: 1.2; }
    .btn-icon div { font-weight: bold; font-size: 9px; }
    .btn-stop { background: #ffcccc; color: #d00; font-size: 15px; font-weight: bold; }
  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; displayWidth: auto; displayHeight: auto;"
  renderer="precision: mediump; antialias: true; alpha: true;"
>
  <a-assets>
    <audio id="snd-horn" src="horn.mp3" preload="auto"></audio>
    <audio id="snd-run" src="run.mp3" preload="auto" loop></audio>
  </a-assets>

  <a-light type="ambient" color="#FFF" intensity="0.8"></a-light>
  <a-light type="directional" position="-1 2 1" intensity="0.6"></a-light>

  <a-camera position="0 1.6 5" look-controls="enabled: true"></a-camera>

  <a-entity id="train"
            gltf-model="models/AR-Train_Nagai.glb"
            position="0 0 0"
            rotation="0 0 0"
            scale="0.5 0.5 0.5">
    
<a-entity id="headlights" visible="false">
      
      <a-sphere radius="0.12" position="-0.186 3.7 -0.5" 
                material="color: #ffffcc; shader: flat"></a-sphere>
      <a-cone height="15" radius-bottom="3" radius-top="0.1" 
              position="-0.186 3.7 7.0" rotation="-90 0 0"
              material="color: #ffffcc; opacity: 0.2; transparent: true; shader: flat; side: double; depthWrite: false">
      </a-cone>

      <a-sphere radius="0.12" position="0.186 3.7 -0.5" 
                material="color: #ffffcc; shader: flat"></a-sphere>
      <a-cone height="15" radius-bottom="3" radius-top="0.1" 
              position="0.186 3.7 7.0" rotation="-90 0 0"
              material="color: #ffffcc; opacity: 0.2; transparent: true; shader: flat; side: double; depthWrite: false">
      </a-cone>


      <a-sphere radius="0.15" position="-1.05 1.2 -0.5" 
                material="color: #ffffcc; shader: flat"></a-sphere>
      <a-cone height="15" radius-bottom="3" radius-top="0.1" 
              position="-1.05 1.2 7.0" rotation="-90 0 0"
              material="color: #ffffcc; opacity: 0.2; transparent: true; shader: flat; side: double; depthWrite: false">
      </a-cone>

      <a-sphere radius="0.15" position="1.05 1.2 -0.5" 
                material="color: #ffffcc; shader: flat"></a-sphere>
      <a-cone height="15" radius-bottom="3" radius-top="0.1" 
              position="1.05 1.2 7.0" rotation="-90 0 0"
              material="color: #ffffcc; opacity: 0.2; transparent: true; shader: flat; side: double; depthWrite: false">
      </a-cone>

  </a-entity>
</a-scene>

<div id="top-ui-container">
  <div class="ui-bar">
    <div class="btn btn-icon" id="btn-face"><span>ğŸ™‚</span><div>é¡”UP</div></div>
    <div class="btn btn-icon" id="btn-light"><span>ğŸ’¡</span><div>ï¾—ï½²ï¾„</div></div>
    <div class="btn btn-icon" id="btn-horn"><span>ğŸ“¢</span><div>è­¦ç¬›</div></div>
    <div class="btn btn-icon" id="btn-up"><span>â¬†</span><div>é«˜</div></div>
    <div class="btn btn-icon" id="btn-down"><span>â¬‡</span><div>ä½</div></div>
    <div class="btn btn-icon" id="btn-zoom-in"><span>ğŸ”</span><div>+</div></div>
    <div class="btn btn-icon" id="btn-zoom-out"><span>ğŸ”</span><div>-</div></div>
  </div>
  <div class="ui-bar">
    <div class="btn btn-icon" id="btn-capture"><span>ğŸ“·</span><div>æ’®</div></div>
    <div class="btn btn-icon" id="btn-face-left"><span>â†</span><div>é¡”</div></div>
    <div class="btn btn-icon" id="btn-face-right"><span>â†’</span><div>é¡”</div></div>
    <div class="btn btn-icon" id="btn-face-up"><span>â†‘</span><div>é¡”</div></div>
    <div class="btn btn-icon" id="btn-face-down"><span>â†“</span><div>é¡”</div></div>
    <div class="btn btn-icon" id="btn-face-big"><span>ï¼‹</span><div>å¤§</div></div>
    <div class="btn btn-icon" id="btn-face-small"><span>ï¼</span><div>å°</div></div>
  </div>
</div>

<div id="bottom-ui-container">
  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>
    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>
    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
function onResize() {
  const scene = document.querySelector('a-scene');
  const video = document.getElementById('arjs-video');
  if (scene && scene.renderer) {
    const w = window.innerWidth; const h = window.innerHeight;
    scene.renderer.setSize(w, h); scene.camera.aspect = w / h; scene.camera.updateProjectionMatrix();
  }
  if (video) { video.style.width = '100%'; video.style.height = '100%'; video.style.objectFit = 'cover'; }
}
window.addEventListener('load', onResize);
window.addEventListener('resize', onResize);

/* ========== éŸ³å£°ãƒ»ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ ========== */
const hornAudio = document.getElementById('snd-horn');
const runAudio = document.getElementById('snd-run');
const headlights = document.getElementById('headlights');
let isLightOn = false;
let isRunningSoundPlaying = false;

document.body.addEventListener('touchstart', function() {
  if (hornAudio) hornAudio.load();
  if (runAudio) runAudio.load();
}, { once: true });

const btnHorn = document.getElementById('btn-horn');
const playHorn = (e) => {
  if(e.cancelable) e.preventDefault();
  if(hornAudio) {
    hornAudio.currentTime = 0;
    hornAudio.play().catch(()=>{});
    btnHorn.classList.add('btn-active');
  }
};
const stopHorn = (e) => {
  if(e.cancelable) e.preventDefault();
  if(hornAudio) {
    hornAudio.pause();
    hornAudio.currentTime = 0;
    btnHorn.classList.remove('btn-active');
  }
};
btnHorn.addEventListener('touchstart', playHorn, {passive:false});
btnHorn.addEventListener('mousedown', playHorn);
btnHorn.addEventListener('touchend', stopHorn, {passive:false});
btnHorn.addEventListener('mouseup', stopHorn);
btnHorn.addEventListener('mouseleave', stopHorn);

document.getElementById('btn-light').onclick = function() {
  isLightOn = !isLightOn;
  headlights.setAttribute('visible', isLightOn);
  if(isLightOn) this.classList.add('btn-active');
  else this.classList.remove('btn-active');
};

/* ========== è»Šä¸¡æ“ä½œ ========== */
const train = document.querySelector('#train');
let speed = 0.05;
let turnSpeedInPlace = 2.0; 
let turnSpeedCurve = 0.5;   
let state = { moving: 0, turning: 0 };

function loop() {
  requestAnimationFrame(loop);
  if (!train.object3D) return;
  const mesh = train.object3D;

  if (state.moving !== 0) {
    if (!isRunningSoundPlaying && runAudio) {
      runAudio.play().catch(()=>{});
      isRunningSoundPlaying = true;
    }
  } else {
    if (isRunningSoundPlaying && runAudio) {
      runAudio.pause();
      runAudio.currentTime = 0;
      isRunningSoundPlaying = false;
    }
  }

  if (state.turning !== 0) {
    let rotationAmount = 0;
    if (state.moving !== 0) {
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedCurve) * state.turning;
      if (state.moving === -1) rotationAmount *= -1; 
    } else {
      rotationAmount = THREE.MathUtils.degToRad(turnSpeedInPlace) * state.turning;
    }
    mesh.rotation.y += rotationAmount;
  }

  if (state.moving !== 0) {
    const forward = new THREE.Vector3(0, 0, -1);
    forward.applyQuaternion(mesh.quaternion);
    forward.normalize();
    mesh.position.addScaledVector(forward, state.moving * speed);
  }
}
loop();

function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if(!btn) return;
  const start = (e) => { if(e.cancelable) e.preventDefault(); state.moving = moveVal; state.turning = turnVal; };
  const end = (e) => { if(e.cancelable) e.preventDefault(); state.moving = 0; state.turning = 0; };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}
setAction('btn-fwd', 1, 0); setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1); setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1); setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1); setAction('btn-curve-right-back', -1, -1);
document.getElementById('btn-stop').addEventListener('click', (e)=>{ e.preventDefault(); state.moving=0; state.turning=0; });

document.getElementById('btn-up').onclick = () => train.object3D.position.y += 0.1;
document.getElementById('btn-down').onclick = () => train.object3D.position.y -= 0.1;
let curScale = 0.5;
document.getElementById('btn-zoom-in').onclick = () => { curScale += 0.05; train.object3D.scale.set(curScale,curScale,curScale); };
document.getElementById('btn-zoom-out').onclick = () => { curScale = Math.max(0.1, curScale - 0.05); train.object3D.scale.set(curScale,curScale,curScale); };
document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  cvs.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ar_snapshot.png'; a.click(); });
};

const createOrUpdateFace = (tex) => {
  const oldFace = train.object3D.getObjectByName('Face_Plate');
  if(oldFace) train.object3D.remove(oldFace);
  const geo = new THREE.PlaneGeometry(0.6, 0.6);
  const mat = new THREE.MeshBasicMaterial({ 
    map: tex || null, color: tex ? 0xffffff : 0xffffff, side: THREE.DoubleSide, 
    transparent: true, depthTest: false, depthWrite: false
  });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.name = 'Face_Plate'; mesh.renderOrder = 9999; 
  mesh.position.set(1.0, 2.84, -0.5); 
  train.object3D.add(mesh);
};
train.addEventListener('model-loaded', () => {
  if (!train.object3D.getObjectByName('Face_Plate')) createOrUpdateFace(null);
});
document.getElementById('btn-face').onclick = () => {
  const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      const img = new Image(); img.src = ev.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const MAX_SIZE = 1024; 
        let w = img.width, h = img.height;
        if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } }
        else { if (h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        new THREE.TextureLoader().load(canvas.toDataURL('image/jpeg', 0.8), (tex) => {
          tex.encoding = THREE.sRGBEncoding; tex.flipY = true; 
          createOrUpdateFace(tex);
        });
      };
    };
    reader.readAsDataURL(file);
  };
  input.click();
};

const adjustFace = (axis, val) => {
  const face = train.object3D.getObjectByName('Face_Plate');
  if (!face) return;
  if (axis === 'x') face.position.x += val;
  if (axis === 'y') face.position.y += val;
  if (axis === 'scale') { const s = face.scale.x + val; if (s > 0.1) face.scale.set(s, s, s); }
};
document.getElementById('btn-face-left').onclick = () => adjustFace('x', -0.05);
document.getElementById('btn-face-right').onclick = () => adjustFace('x', 0.05);
document.getElementById('btn-face-up').onclick = () => adjustFace('y', 0.05);
document.getElementById('btn-face-down').onclick = () => adjustFace('y', -0.05);
document.getElementById('btn-face-big').onclick = () => adjustFace('scale', 0.1);
document.getElementById('btn-face-small').onclick = () => adjustFace('scale', -0.1);
</script>
</body>
</html>